---
---

<div class="rsvp-wrapper">
  <div class="rsvp-inner">
    <h2 class="rsvp-title">RSVP & Message Board</h2>
    
    <!-- RSVP Form -->
    <div class="rsvp-form-container">
      <form id="rsvpForm" class="rsvp-form">
        <div class="form-group">
          <label for="guestName">Your Name</label>
          <input 
            type="text" 
            id="guestName" 
            name="guestName" 
            required 
            maxlength="100"
            placeholder="Enter your name"
          />
        </div>

        <div class="form-group">
          <label>Will you be attending?</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="attending" value="yes" required />
              <span class="radio-custom"></span>
              <span>Yes, I'll be there!</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="attending" value="no" required />
              <span class="radio-custom"></span>
              <span>Sorry, I can't make it</span>
            </label>
          </div>
        </div>

        <div class="form-group" id="guestCountGroup" style="display: none;">
          <label for="guestCount">Number of Guests</label>
          <select id="guestCount" name="guestCount">
            <option value="1">1 person</option>
            <option value="2">2 people</option>
          </select>
        </div>

        <div class="form-group">
          <label for="message">Message for the Couple</label>
          <textarea 
            id="message" 
            name="message" 
            required 
            maxlength="200"
            rows="4"
            placeholder="Write your wishes here..."
          ></textarea>
          <span class="char-count"><span id="charCount">0</span>/200</span>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          <span class="btn-text">Send RSVP</span>
          <span class="btn-loading" style="display: none;">Sending...</span>
        </button>
      </form>

      <div class="success-message" id="successMessage" style="display: none;">
        <div class="success-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20,6 9,17 4,12"></polyline>
          </svg>
        </div>
        <p>Thank you for your RSVP!</p>
        <p class="success-sub">Your message has been added to the board.</p>
      </div>
    </div>

    <!-- Messages Section -->
    <div class="messages-section">
      <h3 class="messages-title">Messages from Guests</h3>
      <div class="messages-grid" id="messagesGrid">
        <!-- Messages will be loaded here -->
      </div>
      <button class="load-more-btn" id="loadMoreBtn" style="display: none;">
        Load More Messages
      </button>
    </div>
  </div>
</div>

<script>
  import { initializeFirebase, collection, addDoc, onSnapshot, query, orderBy, limit, startAfter, type QueryDocumentSnapshot } from '../lib/firebase';
  import { Timestamp } from 'firebase/firestore';

  // Initialize Firebase
  const { db } = initializeFirebase();
  const rsvpsCollection = collection(db, 'rsvps');

  // DOM Elements
  const form = document.getElementById('rsvpForm') as HTMLFormElement;
  const guestNameInput = document.getElementById('guestName') as HTMLInputElement;
  const attendingRadios = document.querySelectorAll('input[name="attending"]') as NodeListOf<HTMLInputElement>;
  const guestCountGroup = document.getElementById('guestCountGroup') as HTMLDivElement;
  const guestCountSelect = document.getElementById('guestCount') as HTMLSelectElement;
  const messageInput = document.getElementById('message') as HTMLTextAreaElement;
  const charCountSpan = document.getElementById('charCount') as HTMLSpanElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
  const successMessage = document.getElementById('successMessage') as HTMLDivElement;
  const messagesGrid = document.getElementById('messagesGrid') as HTMLDivElement;
  const loadMoreBtn = document.getElementById('loadMoreBtn') as HTMLButtonElement;

  // State
  let lastVisible: QueryDocumentSnapshot | null = null;
  const MESSAGES_PER_PAGE = 5;

  // Show/hide guest count based on attending selection
  attendingRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      if (target.value === 'yes') {
        guestCountGroup.style.display = 'block';
        guestCountSelect.required = true;
      } else {
        guestCountGroup.style.display = 'none';
        guestCountSelect.required = false;
        guestCountSelect.value = '';
      }
    });
  });

  // Character counter
  messageInput.addEventListener('input', () => {
    charCountSpan.textContent = messageInput.value.length.toString();
  });

  // Format relative time
  function getRelativeTime(timestamp: Timestamp): string {
    const now = new Date();
    const date = timestamp.toDate();
    const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

    if (diffInSeconds < 60) return 'just now';
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
    if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} days ago`;
    
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }

  // Create message card HTML
  function createMessageCard(data: any, id: string): string {
    const isAttending = data.attending === true;
    const statusIcon = isAttending ? '✓' : '✗';
    const statusClass = isAttending ? 'attending' : 'not-attending';
    const timeAgo = data.timestamp ? getRelativeTime(data.timestamp) : '';

    return `
      <div class="message-card" data-id="${id}">
        <div class="message-card-header">
          <span class="status-badge ${statusClass}">${statusIcon}</span>
          <h4 class="guest-name">${escapeHtml(data.name)}</h4>
        </div>
        <div class="message-card-body">
          <p class="guest-message">${escapeHtml(data.message)}</p>
        </div>
        <div class="message-card-footer">
          <span class="timestamp">${timeAgo}</span>
        </div>
      </div>
    `;
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Load messages (real-time)
  function loadMessages() {
    const q = query(
      rsvpsCollection,
      orderBy('timestamp', 'desc'),
      limit(MESSAGES_PER_PAGE)
    );

    onSnapshot(q, (snapshot) => {
      if (snapshot.empty) {
        messagesGrid.innerHTML = '<p class="no-messages">No messages yet. Be the first to leave a message!</p>';
        loadMoreBtn.style.display = 'none';
        return;
      }

      const messages = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));

      lastVisible = snapshot.docs[snapshot.docs.length - 1];
      
      messagesGrid.innerHTML = messages.map(msg => createMessageCard(msg, msg.id)).join('');
      
      loadMoreBtn.style.display = snapshot.docs.length === MESSAGES_PER_PAGE ? 'block' : 'none';
    }, (error) => {
      console.error('Error loading messages:', error);
      messagesGrid.innerHTML = '<p class="no-messages">Unable to load messages. Please try again later.</p>';
    });
  }

  // Load more messages
  loadMoreBtn.addEventListener('click', async () => {
    if (!lastVisible) return;

    loadMoreBtn.disabled = true;
    loadMoreBtn.textContent = 'Loading...';

    try {
      const { getDocs } = await import('firebase/firestore');
      const q = query(
        rsvpsCollection,
        orderBy('timestamp', 'desc'),
        startAfter(lastVisible),
        limit(MESSAGES_PER_PAGE)
      );

      const snapshot = await getDocs(q);
      
      if (!snapshot.empty) {
        const newMessages = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        lastVisible = snapshot.docs[snapshot.docs.length - 1];
        
        const newCards = newMessages.map(msg => createMessageCard(msg, msg.id)).join('');
        messagesGrid.insertAdjacentHTML('beforeend', newCards);
        
        loadMoreBtn.style.display = snapshot.docs.length === MESSAGES_PER_PAGE ? 'block' : 'none';
      } else {
        loadMoreBtn.style.display = 'none';
      }
    } catch (error) {
      console.error('Error loading more messages:', error);
    } finally {
      loadMoreBtn.disabled = false;
      loadMoreBtn.textContent = 'Load More Messages';
    }
  });

  // Handle form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = guestNameInput.value.trim();
    const attendingRadio = document.querySelector('input[name="attending"]:checked') as HTMLInputElement;
    const attending = attendingRadio.value === 'yes';
    const guestCount = attending ? parseInt(guestCountSelect.value) : null;
    const message = messageInput.value.trim();

    submitBtn.disabled = true;
    const btnText = submitBtn.querySelector('.btn-text') as HTMLSpanElement;
    const btnLoading = submitBtn.querySelector('.btn-loading') as HTMLSpanElement;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';

    try {
      await addDoc(rsvpsCollection, {
        name,
        attending,
        guestCount,
        message,
        timestamp: Timestamp.now()
      });

      form.style.display = 'none';
      successMessage.style.display = 'block';

      setTimeout(() => {
        form.reset();
        charCountSpan.textContent = '0';
        guestCountGroup.style.display = 'none';
        form.style.display = 'block';
        successMessage.style.display = 'none';
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
      }, 3000);

    } catch (error) {
      console.error('Error submitting RSVP:', error);
      alert('Failed to send RSVP. Please try again.');
      submitBtn.disabled = false;
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
    }
  });

  // Load initial messages
  loadMessages();
</script>

<style>
  .rsvp-wrapper {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    box-sizing: border-box;
    background-color: #517470;
  }

  .rsvp-inner {
    width: min(100vw, 50vh);
    max-width: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    container-type: inline-size;
    background-color: #efefef;
    padding: 4cqi;
    padding-top: calc(var(--calculated-width) * 0.1);
    box-sizing: border-box;
    overflow: hidden;
    object-fit: cover;
  }

  .rsvp-title {
    text-align: center;
    color: #333;
    font-size: 5cqi;
    margin: 0 0 4cqi 0;
    font-family: 'palmaton', serif;
    font-size: 9cqi;
    font-weight: 400;
    flex-shrink: 0;
  }

  .rsvp-form-container {
    background-color: #ffffff;
    border-radius: 2cqi;
    padding: 4cqi;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 4cqi;
  }

  .rsvp-form {
    display: flex;
    flex-direction: column;
    gap: 3cqi;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 1cqi;
  }

  .form-group label {
    font-size: 3cqi;
    font-weight: 600;
    color: #333;
  }

  .form-group input[type="text"],
  .form-group textarea,
  .form-group select {
    padding: 2cqi;
    border: 1px solid #ddd;
    border-radius: 1cqi;
    font-size: 2.5cqi;
    font-family: inherit;
    background-color: #fafafa;
    transition: border-color 0.3s ease;
  }

  .form-group input[type="text"]:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    outline: none;
    border-color: #848b79;
    background-color: #ffffff;
  }

  .form-group textarea {
    resize: vertical;
    min-height: 80px;
  }

  .char-count {
    font-size: 2cqi;
    color: #666;
    text-align: right;
  }

  .radio-group {
    display: flex;
    gap: 4cqi;
  }

  .radio-label {
    display: flex;
    align-items: center;
    gap: 1cqi;
    cursor: pointer;
    font-size: 2.5cqi;
    color: #333;
  }

  .radio-label input[type="radio"] {
    display: none;
  }

  .radio-custom {
    width: 3cqi;
    height: 3cqi;
    border: 2px solid #848b79;
    border-radius: 50%;
    position: relative;
    transition: all 0.3s ease;
  }

  .radio-label input[type="radio"]:checked + .radio-custom::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 1.5cqi;
    height: 1.5cqi;
    background-color: #848b79;
    border-radius: 50%;
  }

  .submit-btn {
    background-color: #848b79;
    color: white;
    border: none;
    padding: 2.5cqi 4cqi;
    font-size: 3cqi;
    font-weight: 600;
    border-radius: 1cqi;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 1cqi;
  }

  .submit-btn:hover:not(:disabled) {
    background-color: #6b7366;
    transform: translateY(-2px);
  }

  .submit-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .success-message {
    text-align: center;
    padding: 4cqi;
  }

  .success-icon {
    width: 8cqi;
    height: 8cqi;
    margin: 0 auto 2cqi;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .success-icon svg {
    width: 100%;
    height: 100%;
  }

  .success-message p {
    font-size: 3.5cqi;
    color: #333;
    margin: 0;
  }

  .success-sub {
    font-size: 2.5cqi !important;
    color: #666 !important;
    margin-top: 1cqi !important;
  }

  .messages-section {
    background-color: #ffffff;
    border-radius: 2cqi;
    padding: 4cqi;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .messages-title {
    text-align: center;
    color: #333;
    font-size: 4cqi;
    margin: 0 0 3cqi 0;
    font-family: 'palmaton', serif;
    font-size: 7cqi;
    font-weight: 400;
  }

  .messages-grid {
    display: flex;
    flex-direction: column;
    gap: 2cqi;
    margin-bottom: 3cqi;
  }

  /* Individual Message Card Styles - Global for dynamically created elements */
  :global(.message-card) {
    background-color: #ffffff !important;
    border: 2px solid #e0e0e0 !important;
    border-radius: 2cqi !important;
    padding: 4cqi !important;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 2cqi !important;
    margin-bottom: 2cqi !important;
  }

  :global(.message-card:hover) {
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15) !important;
    border-color: #d0d0d0 !important;
  }

  :global(.message-card-header) {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    gap: 2cqi !important;
    padding-bottom: 2cqi !important;
    border-bottom: 2px solid #f0f0f0 !important;
  }

  :global(.status-badge) {
    width: 5cqi !important;
    height: 5cqi !important;
    min-width: 5cqi !important;
    min-height: 5cqi !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-weight: bold !important;
    font-size: 2.5cqi !important;
    color: white !important;
    flex-shrink: 0 !important;
  }

  :global(.status-badge.attending) {
    background-color: #4CAF50 !important;
  }

  :global(.status-badge.not-attending) {
    background-color: #f44336 !important;
  }

  :global(.guest-name) {
    margin: 0 !important;
    font-size: 3.5cqi !important;
    color: #333 !important;
    font-weight: 600 !important;
    flex: 1 !important;
    line-height: 1.2 !important;
  }

  :global(.message-card-body) {
    flex: 1 !important;
  }

  :global(.guest-message) {
    margin: 0 !important;
    font-size: 2.8cqi !important;
    color: #555 !important;
    line-height: 1.6 !important;
    word-wrap: break-word !important;
  }

  :global(.message-card-footer) {
    display: flex !important;
    justify-content: flex-end !important;
  }

  :global(.timestamp) {
    font-size: 2.2cqi !important;
    color: #999 !important;
    font-style: italic !important;
  }

  :global(.no-messages),
  :global(.error-message) {
    text-align: center !important;
    padding: 4cqi !important;
    color: #666 !important;
    font-size: 2.5cqi !important;
  }

  .load-more-btn {
    display: block;
    margin: 0 auto;
    padding: 2cqi 4cqi;
    background-color: transparent;
    border: 2px solid #848b79;
    color: #848b79;
    font-size: 2.5cqi;
    font-weight: 600;
    border-radius: 1cqi;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .load-more-btn:hover:not(:disabled) {
    background-color: #848b79;
    color: white;
  }

  .load-more-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>
